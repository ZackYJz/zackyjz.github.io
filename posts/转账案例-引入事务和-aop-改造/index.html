<!DOCTYPE html>
<html><head>
<title>è½¬è´¦æ¡ˆä¾‹-å¼•å…¥äº‹åŠ¡å’ŒAOPæ”¹é€ </title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="é€šè¿‡ç®€å•çš„è½¬è´¦ä¸šåŠ¡æ¡ˆä¾‹ï¼Œä»æœ€åˆæ— äº‹åŠ¡çš„åŸºç¡€åŠŸèƒ½ç‰ˆæœ¬ï¼Œé€šè¿‡ä»£ç†å’ŒAOPé€æ­¥è¿›è¡Œæ”¹é€ å’Œä¼˜åŒ–">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">











<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">


  




<link rel="icon" href="https://logseq.oss-cn-chengdu.aliyuncs.com/noteImg/202203191023457.png">



<link rel="stylesheet" href="https://blog.wvuuvw.xyz/scss/journal.min.75229c530b3f6aa895d7c569612d6ca3e5bef57767db1972945785a7a418f179.css" integrity="sha256-dSKcUws/aqiV18VpYS1so&#43;W&#43;9Xdn2xlylFeFp6QY8Xk=" media="screen">



<link rel="stylesheet" href="https://blog.wvuuvw.xyz/scss/dark-mode.min.c4db381abcd93bb0867e0779702d9c25d111348a10647020dbc43f1f0cb14cbb.css" integrity="sha256-xNs4GrzZO7CGfgd5cC2cJdERNIoQZHAg28Q/HwyxTLs=" media="screen">


<script src="/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Noto+Sans+SC");
</script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Source+Code+Pro|Fira+Mono|Material+Icons");
</script>







  <script src="/js/toc.js"></script>














</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://blog.wvuuvw.xyz/">
    
        <div class="nav-title">
            ZackYJ&#39;s Blog
        </div>
        
        <div class="nav-subtitle">
            Stay hungry , Stay foolish
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                ğŸ“‘ æ–‡ç« 
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                ğŸ—„ åˆ†ç±»
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                ğŸ· æ ‡ç­¾ 
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/project/project">
                ğŸ“‡ é¡¹ç›®
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/about/aboutme">
                ğŸ‘¨â€ğŸ’» å…³äº
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Powered by <a href="https://github.com/gohugoio/hugo">hugo</a>
<br>

&copy;
	
	2022 ZackYJ&#39;s Blog
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- ç›®å½• -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%9f%ba%e7%a1%80%e5%8a%9f%e8%83%bd" onclick="onNavClick(`#åŸºç¡€åŠŸèƒ½-nav`)" id="åŸºç¡€åŠŸèƒ½-nav">
									åŸºç¡€åŠŸèƒ½
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bc%a0%e7%bb%9f%e7%9a%84%e4%ba%8b%e5%8a%a1%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#ä¼ ç»Ÿçš„äº‹åŠ¡æ“ä½œ-nav`)" id="ä¼ ç»Ÿçš„äº‹åŠ¡æ“ä½œ-nav">
									ä¼ ç»Ÿçš„äº‹åŠ¡æ“ä½œ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e8%bf%9e%e6%8e%a5%e7%ba%bf%e7%a8%8b%e7%bb%91%e5%ae%9a%e5%b7%a5%e5%85%b7%e7%b1%bb" onclick="onNavClick(`#è¿æ¥çº¿ç¨‹ç»‘å®šå·¥å…·ç±»-nav`)" id="è¿æ¥çº¿ç¨‹ç»‘å®šå·¥å…·ç±»-nav">
									è¿æ¥çº¿ç¨‹ç»‘å®šå·¥å…·ç±»
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%8b%e5%8a%a1%e7%ae%a1%e7%90%86%e5%99%a8%e5%b7%a5%e5%85%b7%e7%b1%bb" onclick="onNavClick(`#äº‹åŠ¡ç®¡ç†å™¨å·¥å…·ç±»-nav`)" id="äº‹åŠ¡ç®¡ç†å™¨å·¥å…·ç±»-nav">
									äº‹åŠ¡ç®¡ç†å™¨å·¥å…·ç±»
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%94%b9%e9%80%a0-servie-%e5%92%8c-dao" onclick="onNavClick(`#æ”¹é€ -servie-å’Œ-dao-nav`)" id="æ”¹é€ -servie-å’Œ-dao-nav">
									æ”¹é€  Servie å’Œ Dao
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#proxy-%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86%e4%bc%98%e5%8c%96" onclick="onNavClick(`#proxy-åŠ¨æ€ä»£ç†ä¼˜åŒ–-nav`)" id="proxy-åŠ¨æ€ä»£ç†ä¼˜åŒ–-nav">
									Proxy åŠ¨æ€ä»£ç†ä¼˜åŒ–
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#jdk-%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86" onclick="onNavClick(`#jdk-åŠ¨æ€ä»£ç†-nav`)" id="jdk-åŠ¨æ€ä»£ç†-nav">
									JDK åŠ¨æ€ä»£ç†
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#cglib-%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86" onclick="onNavClick(`#cglib-åŠ¨æ€ä»£ç†-nav`)" id="cglib-åŠ¨æ€ä»£ç†-nav">
									CGLIB åŠ¨æ€ä»£ç†
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#aop-%e4%bc%98%e5%8c%96" onclick="onNavClick(`#aop-ä¼˜åŒ–-nav`)" id="aop-ä¼˜åŒ–-nav">
									AOP ä¼˜åŒ–
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    ğŸ“‘ æ–‡ç« 
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    ğŸ—„ åˆ†ç±»
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    ğŸ· æ ‡ç­¾ 
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/project/project">
                    ğŸ“‡ é¡¹ç›®
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/about/aboutme">
                    ğŸ‘¨â€ğŸ’» å…³äº
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- ç›®å½• -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%9f%ba%e7%a1%80%e5%8a%9f%e8%83%bd" onclick="onNavClick(`#åŸºç¡€åŠŸèƒ½-nav`)" id="åŸºç¡€åŠŸèƒ½-nav">
									åŸºç¡€åŠŸèƒ½
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bc%a0%e7%bb%9f%e7%9a%84%e4%ba%8b%e5%8a%a1%e6%93%8d%e4%bd%9c" onclick="onNavClick(`#ä¼ ç»Ÿçš„äº‹åŠ¡æ“ä½œ-nav`)" id="ä¼ ç»Ÿçš„äº‹åŠ¡æ“ä½œ-nav">
									ä¼ ç»Ÿçš„äº‹åŠ¡æ“ä½œ
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e8%bf%9e%e6%8e%a5%e7%ba%bf%e7%a8%8b%e7%bb%91%e5%ae%9a%e5%b7%a5%e5%85%b7%e7%b1%bb" onclick="onNavClick(`#è¿æ¥çº¿ç¨‹ç»‘å®šå·¥å…·ç±»-nav`)" id="è¿æ¥çº¿ç¨‹ç»‘å®šå·¥å…·ç±»-nav">
									è¿æ¥çº¿ç¨‹ç»‘å®šå·¥å…·ç±»
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%ba%8b%e5%8a%a1%e7%ae%a1%e7%90%86%e5%99%a8%e5%b7%a5%e5%85%b7%e7%b1%bb" onclick="onNavClick(`#äº‹åŠ¡ç®¡ç†å™¨å·¥å…·ç±»-nav`)" id="äº‹åŠ¡ç®¡ç†å™¨å·¥å…·ç±»-nav">
									äº‹åŠ¡ç®¡ç†å™¨å·¥å…·ç±»
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%94%b9%e9%80%a0-servie-%e5%92%8c-dao" onclick="onNavClick(`#æ”¹é€ -servie-å’Œ-dao-nav`)" id="æ”¹é€ -servie-å’Œ-dao-nav">
									æ”¹é€  Servie å’Œ Dao
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#proxy-%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86%e4%bc%98%e5%8c%96" onclick="onNavClick(`#proxy-åŠ¨æ€ä»£ç†ä¼˜åŒ–-nav`)" id="proxy-åŠ¨æ€ä»£ç†ä¼˜åŒ–-nav">
									Proxy åŠ¨æ€ä»£ç†ä¼˜åŒ–
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#jdk-%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86" onclick="onNavClick(`#jdk-åŠ¨æ€ä»£ç†-nav`)" id="jdk-åŠ¨æ€ä»£ç†-nav">
									JDK åŠ¨æ€ä»£ç†
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#cglib-%e5%8a%a8%e6%80%81%e4%bb%a3%e7%90%86" onclick="onNavClick(`#cglib-åŠ¨æ€ä»£ç†-nav`)" id="cglib-åŠ¨æ€ä»£ç†-nav">
									CGLIB åŠ¨æ€ä»£ç†
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
						
						
						
							<li>
								<a href="#aop-%e4%bc%98%e5%8c%96" onclick="onNavClick(`#aop-ä¼˜åŒ–-nav`)" id="aop-ä¼˜åŒ–-nav">
									AOP ä¼˜åŒ–
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://blog.wvuuvw.xyz/">
            ZackYJ&#39;s Blog
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://blog.wvuuvw.xyz/">
        <div class="single-column-header-title">ZackYJ&#39;s Blog</div>
        
        <div class="single-column-header-subtitle">Stay hungry , Stay foolish</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            
                
            

            <div class="post-head-wrapper"
                
                    
                    
                    style="background-image: url('https://images.unsplash.com/photo-1616077167555-51f6bc516dfa?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=2071&amp;q=80')"
                    
                
            >
                <div class="post-title">
                    è½¬è´¦æ¡ˆä¾‹-å¼•å…¥äº‹åŠ¡å’ŒAOPæ”¹é€ 
                    
                    <div class="post-subtitle">
                        é€šè¿‡ç®€å•çš„è½¬è´¦ä¸šåŠ¡æ¡ˆä¾‹ï¼Œä»æœ€åˆæ— äº‹åŠ¡çš„åŸºç¡€åŠŸèƒ½ç‰ˆæœ¬ï¼Œé€šè¿‡ä»£ç†å’ŒAOPé€æ­¥è¿›è¡Œæ”¹é€ å’Œä¼˜åŒ–
                    </div>
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2021-01-03 08:31
                        </time>
                        

                        
                            <i class="material-icons" style="">folder</i>
                                <a href="/categories/java">Java</a>
                                &nbsp;
                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tags/spring">spring</a>
                                &nbsp;
                            
                                <a href="/tags/%E4%BA%8B%E5%8A%A1">äº‹åŠ¡</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h3 id="åŸºç¡€åŠŸèƒ½">åŸºç¡€åŠŸèƒ½</h3>
<hr>
<p>spring æ•´åˆ DBUtils ï¼Œå®ç°ç®€å•çš„ç”¨æˆ·è½¬è´¦ä¸šåŠ¡</p>
<ul>
<li>
<p>Account å®ä½“ç±»</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Account</span> <span style="color:#ff79c6">{</span>
  <span style="color:#8be9fd;font-style:italic">private</span> Integer id<span style="color:#ff79c6">;</span>
  <span style="color:#8be9fd;font-style:italic">private</span> String name<span style="color:#ff79c6">;</span>
  <span style="color:#8be9fd;font-style:italic">private</span> Double money<span style="color:#ff79c6">;</span>
  <span style="color:#6272a4">// setter getter....
</span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>AccountDao æ¥å£å’Œå®ç°ç±»</p>
<ul>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">interface</span> <span style="color:#50fa7b">AccountDao</span> <span style="color:#ff79c6">{</span>
  <span style="color:#6272a4">// è½¬å‡ºæ“ä½œ
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">out</span><span style="color:#ff79c6">(</span>String outUser<span style="color:#ff79c6">,</span> Double money<span style="color:#ff79c6">);</span>
  <span style="color:#6272a4">// è½¬å…¥æ“ä½œ
</span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">in</span><span style="color:#ff79c6">(</span>String inUser<span style="color:#ff79c6">,</span> Double money<span style="color:#ff79c6">);</span>
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Repository
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">AccountDaoImpl</span> <span style="color:#8be9fd;font-style:italic">implements</span> AccountDao <span style="color:#ff79c6">{</span>
    @Autowired
    <span style="color:#8be9fd;font-style:italic">private</span> QueryRunner queryRunner<span style="color:#ff79c6">;</span>
    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">out</span><span style="color:#ff79c6">(</span>String outUser<span style="color:#ff79c6">,</span> Double money<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
      <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
          queryRunner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">update</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;update account set money=money-? where name=?&#34;</span><span style="color:#ff79c6">,</span>
          money<span style="color:#ff79c6">,</span> outUser<span style="color:#ff79c6">);</span>
      <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>SQLException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
          e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
      <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">in</span><span style="color:#ff79c6">(</span>String inUser<span style="color:#ff79c6">,</span> Double money<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
      <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
        queryRunner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">update</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;update account set money=money+? where name=?&#34;</span><span style="color:#ff79c6">,</span>
        money<span style="color:#ff79c6">,</span> inUser<span style="color:#ff79c6">);</span>
      <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>SQLException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
      <span style="color:#ff79c6">}</span>
		<span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
</li>
<li>
<p>AccountService æ¥å£å’Œå®ç°ç±»</p>
<ul>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">  <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">interface</span> <span style="color:#50fa7b">AccountService</span> <span style="color:#ff79c6">{</span>
      <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transfer</span><span style="color:#ff79c6">(</span>String outUser<span style="color:#ff79c6">,</span> String inUser<span style="color:#ff79c6">,</span> Double money<span style="color:#ff79c6">);</span>
  <span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Service
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">AccountServiceImpl</span> <span style="color:#8be9fd;font-style:italic">implements</span> AccountService <span style="color:#ff79c6">{</span>
    @Autowired
    <span style="color:#8be9fd;font-style:italic">private</span> AccountDao accountDao<span style="color:#ff79c6">;</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transfer</span><span style="color:#ff79c6">(</span>String outUser<span style="color:#ff79c6">,</span> String inUser<span style="color:#ff79c6">,</span> Double money<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
      accountDao<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">(</span>outUser<span style="color:#ff79c6">,</span> money<span style="color:#ff79c6">);</span>
      accountDao<span style="color:#ff79c6">.</span><span style="color:#50fa7b">in</span><span style="color:#ff79c6">(</span>inUser<span style="color:#ff79c6">,</span> money<span style="color:#ff79c6">);</span>
		<span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
</li>
</ul>
<blockquote>
<p>è‡³æ­¤å®ç°äº†åŸºæœ¬çš„ä¸šåŠ¡è½¬è´¦é€»è¾‘ï¼Œä½†ä»¥ä¸Šä»£ç ä¸­ï¼Œä¼ å‡ºå’Œè½¬å…¥æ“ä½œåœ¨ Dao å±‚å®ç°ï¼Œåˆ†åˆ«éƒ½æ˜¯ç‹¬ç«‹çš„äº‹åŠ¡ï¼Œå¦‚æœåœ¨è½¬å‡ºåå‘ç”Ÿå¼‚å¸¸ï¼Œè½¬å…¥æ“ä½œä¼šå¾—ä¸åˆ°åŸå­æ€§çš„ä¿è¯ï¼Œå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µ</p>
</blockquote>
<p>æ”¹è¿›ï¼šæŠŠä¸šåŠ¡é€»è¾‘æ§åˆ¶åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œå°†äº‹åŠ¡æŒªåˆ°serviceå±‚</p>
<h3 id="ä¼ ç»Ÿçš„äº‹åŠ¡æ“ä½œ">ä¼ ç»Ÿçš„äº‹åŠ¡æ“ä½œ</h3>
<hr>
<h4 id="è¿æ¥çº¿ç¨‹ç»‘å®šå·¥å…·ç±»">è¿æ¥çº¿ç¨‹ç»‘å®šå·¥å…·ç±»</h4>
<p>ä¸ºäº†ä¿è¯åœ¨ Dao å±‚è°ƒç”¨ in,out æ–¹æ³•çš„æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œç¼–å†™ä¸€ä¸ªè¿æ¥å·¥å…·ç±»ï¼Œä»æ•°æ®åº“è·å–è¿æ¥å¯¹è±¡ï¼Œåˆ©ç”¨ ThreadLocal  å®ç°å’Œçº¿ç¨‹çš„ç»‘å®š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">ConnectionUtils</span> <span style="color:#ff79c6">{</span>
    @Autowired
    <span style="color:#8be9fd;font-style:italic">private</span> DataSource dataSource<span style="color:#ff79c6">;</span>
    <span style="color:#8be9fd;font-style:italic">private</span> ThreadLocal<span style="color:#ff79c6">&lt;</span>Connection<span style="color:#ff79c6">&gt;</span> threadLocal <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ThreadLocal<span style="color:#ff79c6">&lt;&gt;();</span>

    <span style="color:#6272a4">/*
</span><span style="color:#6272a4">        è·å–å½“å‰çº¿ç¨‹ä¸Šç»‘å®šè¿æ¥ï¼šå¦‚æœè·å–åˆ°çš„è¿æ¥ä¸ºç©ºï¼Œé‚£ä¹ˆå°±è¦ä»æ•°æ®æºä¸­è·å–è¿æ¥ï¼Œå¹¶ä¸”æ”¾åˆ°ThreadLocalä¸­ï¼ˆç»‘å®šåˆ°å½“å‰çº¿ç¨‹ï¼‰
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span>  Connection <span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">(){</span>
        <span style="color:#6272a4">// 1. å…ˆä»ThreadLocalä¸Šè·å–è¿æ¥
</span><span style="color:#6272a4"></span>        Connection connection <span style="color:#ff79c6">=</span> threadLocal<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">();</span>

        <span style="color:#6272a4">// 2. åˆ¤æ–­å½“å‰çº¿ç¨‹ä¸­æ˜¯å¦æ˜¯æœ‰Connection
</span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">if</span><span style="color:#ff79c6">(</span>connection <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">){</span>
            <span style="color:#6272a4">// 3. ä»æ•°æ®æºä¸­è·å–ä¸€ä¸ªè¿æ¥ï¼Œå¹¶ä¸”å­˜å…¥ThreadLocalä¸­
</span><span style="color:#6272a4"></span>            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                <span style="color:#6272a4">// ä¸ä¸ºnull
</span><span style="color:#6272a4"></span>                connection <span style="color:#ff79c6">=</span> dataSource<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getConnection</span><span style="color:#ff79c6">();</span>

                threadLocal<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>connection<span style="color:#ff79c6">);</span>

            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>SQLException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
            <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">return</span>  connection<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
    <span style="color:#6272a4">/*
</span><span style="color:#6272a4">        è§£é™¤å½“å‰çº¿ç¨‹çš„è¿æ¥ç»‘å®š
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span>  <span style="color:#50fa7b">removeThreadConnection</span><span style="color:#ff79c6">(){</span>
        threadLocal<span style="color:#ff79c6">.</span><span style="color:#50fa7b">remove</span><span style="color:#ff79c6">();</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="äº‹åŠ¡ç®¡ç†å™¨å·¥å…·ç±»">äº‹åŠ¡ç®¡ç†å™¨å·¥å…·ç±»</h4>
<p>å°è£…äº‹åŠ¡æ“ä½œï¼Œé€šè¿‡ä¸Šé¢çš„çº¿ç¨‹ç»‘å®šå·¥å…·ç±»è·å– Connection</p>
<p>åœ¨è¿™ä¸ªå·¥å…·ç±»ä¸­ï¼Œè¿›è¡Œå¼€å¯äº‹åŠ¡ã€æäº¤äº‹åŠ¡ã€å›æ»šäº‹åŠ¡ã€é‡Šæ”¾èµ„æºçš„ç»Ÿä¸€æ§åˆ¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Component<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;transactionManager&#34;</span><span style="color:#ff79c6">)</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">TransactionManager</span> <span style="color:#ff79c6">{</span>

    @Autowired
    <span style="color:#8be9fd;font-style:italic">private</span> ConnectionUtils connectionUtils<span style="color:#ff79c6">;</span>

    <span style="color:#6272a4">/*
</span><span style="color:#6272a4">      å¼€å¯äº‹åŠ¡
</span><span style="color:#6272a4">    */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">beginTransaction</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>

        <span style="color:#6272a4">// è·å–connectionå¯¹è±¡
</span><span style="color:#6272a4"></span>        Connection connection <span style="color:#ff79c6">=</span> connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// å¼€å¯äº†ä¸€ä¸ªæ‰‹åŠ¨äº‹åŠ¡
</span><span style="color:#6272a4"></span>            connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAutoCommit</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>SQLException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span>

    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">/*
</span><span style="color:#6272a4">        æäº¤äº‹åŠ¡
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">commit</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        Connection connection <span style="color:#ff79c6">=</span> connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">commit</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>SQLException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span>

    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">/*
</span><span style="color:#6272a4">        å›æ»šäº‹åŠ¡
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">rollback</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        Connection connection <span style="color:#ff79c6">=</span> connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">rollback</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>SQLException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>

    <span style="color:#6272a4">/*
</span><span style="color:#6272a4">        é‡Šæ”¾èµ„æº
</span><span style="color:#6272a4">     */</span>
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">release</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">// å°†æ‰‹åŠ¨äº‹åŠ¡æ”¹å›æˆè‡ªåŠ¨æäº¤äº‹åŠ¡
</span><span style="color:#6272a4"></span>        Connection connection <span style="color:#ff79c6">=</span> connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            connection<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAutoCommit</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
            <span style="color:#6272a4">// å°†è¿æ¥å½’è¿˜åˆ°è¿æ¥æ± 
</span><span style="color:#6272a4"></span>            connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
            <span style="color:#6272a4">// è§£é™¤çº¿ç¨‹ç»‘å®š
</span><span style="color:#6272a4"></span>            connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">removeThreadConnection</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>SQLException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h4 id="æ”¹é€ -servie-å’Œ-dao">æ”¹é€  Servie å’Œ Dao</h4>
<ul>
<li>
<p>Service å±‚ä¸­è¿›è¡Œæ‰‹åŠ¨å¼€å¯äº‹åŠ¡ï¼Œæ— è¯¯åˆ™æ‰‹åŠ¨æäº¤ï¼Œå¼‚å¸¸åˆ™å›æ»š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transfer</span><span style="color:#ff79c6">(</span>String outUser<span style="color:#ff79c6">,</span> String inUser<span style="color:#ff79c6">,</span> Double money<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        <span style="color:#6272a4">//æ‰‹åŠ¨å¼€å¯äº‹åŠ¡
</span><span style="color:#6272a4"></span>        transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">beginTransaction</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            accountDao<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">(</span>outUser<span style="color:#ff79c6">,</span>money<span style="color:#ff79c6">);</span>
            accountDao<span style="color:#ff79c6">.</span><span style="color:#50fa7b">in</span><span style="color:#ff79c6">(</span>inUser<span style="color:#ff79c6">,</span> money<span style="color:#ff79c6">);</span>
            <span style="color:#6272a4">//æ‰‹åŠ¨æäº¤äº‹åŠ¡
</span><span style="color:#6272a4"></span>            transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">commit</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">rollback</span><span style="color:#ff79c6">();</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">release</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span>
</code></pre></div></li>
<li>
<p>Dao æ–¹æ³•ä¸­ä½¿ç”¨ DBUtils æ—¶ï¼Œä¼ å…¥ä» ConnectionManager ä¸­è·å–çš„ Connection</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"> <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">out</span><span style="color:#ff79c6">(</span>String outAccount<span style="color:#ff79c6">,</span> Double money<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String sql <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;update account set money = money - ? where name = ?&#34;</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            queryRunner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">update</span><span style="color:#ff79c6">(</span>connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">(),</span> sql<span style="color:#ff79c6">,</span>money<span style="color:#ff79c6">,</span>outAccount<span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>SQLException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>

    @Override
    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">in</span><span style="color:#ff79c6">(</span>String inAccount<span style="color:#ff79c6">,</span> Double money<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
        String sql <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;update account set money=money+? where name=?&#34;</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
         queryRunner<span style="color:#ff79c6">.</span><span style="color:#50fa7b">update</span><span style="color:#ff79c6">(</span>connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">(),</span>sql<span style="color:#ff79c6">,</span>money<span style="color:#ff79c6">,</span>inAccount<span style="color:#ff79c6">);</span>
        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>SQLException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span>
    <span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<blockquote>
<p>é€šè¿‡ä»¥ä¸Šçš„æ”¹é€ ï¼Œå·²ç»å®ç°äº†ä¸šåŠ¡æ§åˆ¶ï¼Œä½†ä¹Ÿå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼š</p>
</blockquote>
<p>ä¸šåŠ¡å±‚æ–¹æ³•å˜å¾—è‡ƒè‚¿äº†ï¼Œä¸šåŠ¡é€»è¾‘å’Œäº‹åŠ¡æ§åˆ¶æ–¹æ³•è€¦åˆï¼Œå¦‚æœä¸šåŠ¡å±‚æ–¹æ³•è¶Šæ¥è¶Šå¤šï¼Œå°†å……æ–¥ç€é‡å¤çš„ä»£ç ï¼Œè¿èƒŒäº†é¢å‘å¯¹è±¡ä½è€¦åˆçš„å¼€å‘æ€æƒ³</p>
<h3 id="proxy-åŠ¨æ€ä»£ç†ä¼˜åŒ–">Proxy åŠ¨æ€ä»£ç†ä¼˜åŒ–</h3>
<hr>
<p>æ€è·¯ï¼šå°†ä¸šåŠ¡ä»£ç å’Œäº‹åŠ¡æ§åˆ¶ä»£ç åˆ†ç¦»ï¼Œé€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼å¯¹ä¸šåŠ¡æ–¹æ³•è¿›è¡Œäº‹åŠ¡å¢å¼ºï¼Œä»¥é™ä½è€¦åˆä»è€Œä¸å¯¹ä¸šåŠ¡å±‚äº§ç”Ÿå½±å“</p>
<h4 id="jdk-åŠ¨æ€ä»£ç†">JDK åŠ¨æ€ä»£ç†</h4>
<p>åŸºäºæ¥å£çš„åŠ¨æ€ä»£ç†ï¼Œè¢«ä»£ç†çš„ç±»ï¼ˆç›®æ ‡ç±»ï¼‰å¿…é¡»å®ç°ä¸€ä¸ªæ¥å£</p>
<p><img src="https://logseq.oss-cn-chengdu.aliyuncs.com/noteImg/202203122002207.png" alt=""></p>
<p>åˆ©ç”¨å®ç° InvocationHandler æ¥å£çš„æ‹¦æˆªå™¨å’Œåå°„æœºåˆ¶ï¼Œç”Ÿæˆä»£ç†æ¥å£çš„åŒ¿åç±»ï¼ˆä»£ç†å¯¹è±¡ï¼‰ï¼Œåœ¨è°ƒç”¨ç›®æ ‡æ–¹æ³•å‰è°ƒç”¨ InvokeHander æ¥å®ç°æ–¹æ³•å¢å¼º</p>
<ul>
<li>
<p>JDKProxyFactoryï¼šåŠ¨æ€ä»£ç†å·¥å‚ç±»ï¼Œåœ¨è¿”å›çš„åŠ¨æ€ä»£ç†å¯¹è±¡ä¸­è¿›è¡Œäº‹åŠ¡æ§åˆ¶</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Component<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;proxyFactory&#34;</span><span style="color:#ff79c6">)</span>
<span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">JDKProxyFactory</span> <span style="color:#ff79c6">{</span>
    <span style="color:#6272a4">/**
</span><span style="color:#6272a4">     * ç›®æ ‡ç±»ï¼ˆè¢«ä»£ç†å¯¹è±¡ï¼‰
</span><span style="color:#6272a4">     * åˆ©ç”¨æ¥å£æ¥æ¥æ”¶
</span><span style="color:#6272a4">     */</span>
    @Autowired
    <span style="color:#8be9fd;font-style:italic">private</span> AccountService accountService<span style="color:#ff79c6">;</span>

    @Autowired
    <span style="color:#8be9fd;font-style:italic">private</span> TransactionManager transactionManager<span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> AccountService <span style="color:#50fa7b">createAccountServiceJDKProxy</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        AccountService accountServiceProxy <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
        accountServiceProxy <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>AccountService<span style="color:#ff79c6">)</span> Proxy<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newProxyInstance</span><span style="color:#ff79c6">(</span>accountService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getClassLoader</span><span style="color:#ff79c6">(),</span>
                accountService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getInterfaces</span><span style="color:#ff79c6">(),</span><span style="color:#ff79c6">new</span> InvocationHandler<span style="color:#ff79c6">(){</span>

                    @Override
                    <span style="color:#8be9fd;font-style:italic">public</span> Object <span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>Object proxy<span style="color:#ff79c6">,</span> Method method<span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Throwable <span style="color:#ff79c6">{</span>
                        Object result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
                        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                            transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">beginTransaction</span><span style="color:#ff79c6">();</span>
                            result <span style="color:#ff79c6">=</span> method<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>accountService<span style="color:#ff79c6">,</span>args<span style="color:#ff79c6">);</span>
                            transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">commit</span><span style="color:#ff79c6">();</span>
                        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">catch</span><span style="color:#ff79c6">(</span>InvocationTargetException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
                            transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">rollback</span><span style="color:#ff79c6">();</span>
                        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
                            transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">release</span><span style="color:#ff79c6">();</span>
                        <span style="color:#ff79c6">}</span>
                        <span style="color:#ff79c6">return</span> result<span style="color:#ff79c6">;</span>
                    <span style="color:#ff79c6">}</span>
                <span style="color:#ff79c6">});</span>
        <span style="color:#ff79c6">return</span> accountServiceProxy<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div></li>
</ul>
<h4 id="cglib-åŠ¨æ€ä»£ç†">CGLIB åŠ¨æ€ä»£ç†</h4>
<p>åŸºäºçˆ¶ç±»çš„åŠ¨æ€ä»£ç†æŠ€æœ¯ï¼Œæ— éœ€å®ç°æ¥å£</p>
<p>åœ¨è¿è¡Œæ—¶ï¼Œä¸ºä»£ç†ç±»åŠ¨æ€ç”Ÿæˆå­ç±»ï¼Œé‡å†™è¢«ä»£ç†ç±»æ‰€æœ‰é final æ–¹æ³•ã€‚åœ¨å­ç±»ä¸­ä½¿ç”¨æ–¹æ³•æ‹¦æˆªçš„æŠ€æœ¯æ‹¦æˆªæ‰€æœ‰æ–¹æ³•è°ƒç”¨ï¼Œæ¤å…¥æ¨ªåˆ‡é€»è¾‘å¯¹æ–¹æ³•è¿›è¡Œå¢å¼º</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CglibProxyFactory</span> <span style="color:#ff79c6">{</span>
    @Autowired
    <span style="color:#8be9fd;font-style:italic">private</span> AccountService accountService<span style="color:#ff79c6">;</span>
    @Autowired
    <span style="color:#8be9fd;font-style:italic">private</span> TransactionManager transactionManager<span style="color:#ff79c6">;</span>

    <span style="color:#8be9fd;font-style:italic">public</span> AccountService <span style="color:#50fa7b">createAccountServiceCglibProxy</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
        AccountService accountServiceProxy <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
        accountServiceProxy <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>AccountService<span style="color:#ff79c6">)</span>
          Enhancer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">create</span><span style="color:#ff79c6">(</span>accountService<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">(),</span> <span style="color:#ff79c6">new</span> MethodInterceptor<span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
              @Override
              <span style="color:#8be9fd;font-style:italic">public</span> Object <span style="color:#50fa7b">intercept</span><span style="color:#ff79c6">(</span>Object o<span style="color:#ff79c6">,</span> Method method<span style="color:#ff79c6">,</span> Object<span style="color:#ff79c6">[]</span> objects<span style="color:#ff79c6">,</span> MethodProxy methodProxy<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Throwable <span style="color:#ff79c6">{</span>
                  Object result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
                  <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
                      <span style="color:#6272a4">// 1.å¼€å¯äº‹åŠ¡
</span><span style="color:#6272a4"></span>                      transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">beginTransaction</span><span style="color:#ff79c6">();</span>
                      <span style="color:#6272a4">// 2.ä¸šåŠ¡æ“ä½œ
</span><span style="color:#6272a4"></span>                      result <span style="color:#ff79c6">=</span> method<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>accountService<span style="color:#ff79c6">,</span> objects<span style="color:#ff79c6">);</span>
                      <span style="color:#6272a4">// 3.æäº¤äº‹åŠ¡
</span><span style="color:#6272a4"></span>                      transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">commit</span><span style="color:#ff79c6">();</span>
                  <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
                      e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
                      <span style="color:#6272a4">// 4.å›æ»šäº‹åŠ¡
</span><span style="color:#6272a4"></span>                      transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">rollback</span><span style="color:#ff79c6">();</span>
                  <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
                      <span style="color:#6272a4">// 5.é‡Šæ”¾èµ„æº
</span><span style="color:#6272a4"></span>                      transactionManager<span style="color:#ff79c6">.</span><span style="color:#50fa7b">release</span><span style="color:#ff79c6">();</span>
                  <span style="color:#ff79c6">}</span>
                  <span style="color:#ff79c6">return</span> result<span style="color:#ff79c6">;</span>
              <span style="color:#ff79c6">}</span>
          <span style="color:#ff79c6">});</span>
        <span style="color:#ff79c6">return</span> accountServiceProxy<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
<span style="color:#ff79c6">}</span>
</code></pre></div><h3 id="aop-ä¼˜åŒ–">AOP ä¼˜åŒ–</h3>
<p>é…ç½®åˆ‡ç‚¹å’Œåˆ‡é¢</p>
<ul>
<li>XML æ ¼å¼çš„åŸºæœ¬é€šçŸ¥ç±»å‹</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml">    <span style="color:#ff79c6">&lt;aop:config&gt;</span>
<span style="color:#6272a4">&lt;!--        åˆ‡ç‚¹è¡¨è¾¾å¼--&gt;</span>
        <span style="color:#ff79c6">&lt;aop:pointcut</span> <span style="color:#50fa7b">id=</span><span style="color:#f1fa8c">&#34;myPt&#34;</span> <span style="color:#50fa7b">expression=</span><span style="color:#f1fa8c">&#34;execution(* xyz.wvuuvw.service.impl.AccountServiceImpl.*(..))&#34;</span><span style="color:#ff79c6">/&gt;</span>
<span style="color:#6272a4">&lt;!--        åˆ‡é¢é…ç½®--&gt;</span>
        <span style="color:#ff79c6">&lt;aop:aspect</span> <span style="color:#50fa7b">ref=</span><span style="color:#f1fa8c">&#34;transactionManager&#34;</span><span style="color:#ff79c6">&gt;</span>
            <span style="color:#ff79c6">&lt;aop:before</span> <span style="color:#50fa7b">method=</span><span style="color:#f1fa8c">&#34;beginTransaction&#34;</span> <span style="color:#50fa7b">pointcut-ref =</span> <span style="color:#f1fa8c">&#34;myPt&#34;</span><span style="color:#ff79c6">/&gt;</span>
            <span style="color:#ff79c6">&lt;aop:after-returning</span> <span style="color:#50fa7b">method=</span><span style="color:#f1fa8c">&#34;commit&#34;</span> <span style="color:#50fa7b">pointcut-ref =</span> <span style="color:#f1fa8c">&#34;myPt&#34;</span><span style="color:#ff79c6">/&gt;</span>
            <span style="color:#ff79c6">&lt;aop:after-throwing</span> <span style="color:#50fa7b">method=</span><span style="color:#f1fa8c">&#34;rollback&#34;</span> <span style="color:#50fa7b">pointcut-ref =</span> <span style="color:#f1fa8c">&#34;myPt&#34;</span><span style="color:#ff79c6">/&gt;</span>
            <span style="color:#ff79c6">&lt;aop:after</span> <span style="color:#50fa7b">method=</span><span style="color:#f1fa8c">&#34;release&#34;</span> <span style="color:#50fa7b">pointcut-ref =</span> <span style="color:#f1fa8c">&#34;myPt&#34;</span><span style="color:#ff79c6">/&gt;</span>
        <span style="color:#ff79c6">&lt;/aop:aspect&gt;</span>
    <span style="color:#ff79c6">&lt;/aop:config&gt;</span>
</code></pre></div><ul>
<li>æ³¨è§£å½¢å¼çš„ç¯ç»•é€šçŸ¥</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">@Component<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;transactionManager&#34;</span><span style="color:#ff79c6">)</span>
@Aspect <span style="color:#6272a4">//è¡¨æ˜è¯¥ç±»ä¸ºåˆ‡é¢ç±»
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">TransactionManager</span> <span style="color:#ff79c6">{</span>

    @Autowired
    <span style="color:#8be9fd;font-style:italic">private</span> ConnectionUtils connectionUtils<span style="color:#ff79c6">;</span>


    @Around<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;execution(* xyz.wvuuvw.service.impl.AccountServiceImpl.*(..))&#34;</span><span style="color:#ff79c6">)</span>
    <span style="color:#8be9fd;font-style:italic">public</span> Object <span style="color:#50fa7b">around</span><span style="color:#ff79c6">(</span>ProceedingJoinPoint pjp<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> SQLException <span style="color:#ff79c6">{</span>

        Object proceed <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// å¼€å¯æ‰‹åŠ¨äº‹åŠ¡
</span><span style="color:#6272a4"></span>            connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">setAutoCommit</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">);</span>
            <span style="color:#6272a4">// åˆ‡å…¥ç‚¹æ–¹æ³•æ‰§è¡Œ
</span><span style="color:#6272a4"></span>            proceed <span style="color:#ff79c6">=</span> pjp<span style="color:#ff79c6">.</span><span style="color:#50fa7b">proceed</span><span style="color:#ff79c6">();</span>

            <span style="color:#6272a4">// æ‰‹åŠ¨æäº¤äº‹åŠ¡
</span><span style="color:#6272a4"></span>            connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">commit</span><span style="color:#ff79c6">();</span>

        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Throwable throwable<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
            throwable<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
            <span style="color:#6272a4">// æ‰‹åŠ¨å›æ»šäº‹åŠ¡
</span><span style="color:#6272a4"></span>            connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">rollback</span><span style="color:#ff79c6">();</span>

        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
            <span style="color:#6272a4">// å°†æ‰‹åŠ¨äº‹åŠ¡æ¢å¤æˆè‡ªåŠ¨äº‹åŠ¡
</span><span style="color:#6272a4"></span>            connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">setAutoCommit</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
            <span style="color:#6272a4">// å°†è¿æ¥å½’è¿˜åˆ°è¿æ¥æ± 
</span><span style="color:#6272a4"></span>            connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getThreadConnection</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
            <span style="color:#6272a4">// è§£é™¤çº¿ç¨‹ç»‘å®š
</span><span style="color:#6272a4"></span>            connectionUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">removeThreadConnection</span><span style="color:#ff79c6">();</span>
        <span style="color:#ff79c6">}</span>
        <span style="color:#ff79c6">return</span>  proceed<span style="color:#ff79c6">;</span>
    <span style="color:#ff79c6">}</span>
  <span style="color:#ff79c6">....</span>
</code></pre></div>
                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">æœ€åä¿®æ”¹äº 2021-01-03</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://blog.wvuuvw.xyz/posts/%E7%BB%8F%E5%85%B8%E7%BC%93%E5%AD%98%E8%AE%BE%E8%AE%A1/">
			ä¸Šä¸€ç¯‡<br>ç»å…¸ç¼“å­˜è®¾è®¡æ€è·¯
                </a>
                
                
                
                <a class="older-posts" href="https://blog.wvuuvw.xyz/posts/redis%E7%BC%93%E5%AD%98%E6%A1%88%E4%BE%8B/">
			ä¸‹ä¸€ç¯‡<br>Redisç¼“å­˜è®¾è®¡æ¡ˆä¾‹
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                










            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">
Powered by <a href="https://github.com/gohugoio/hugo">hugo</a>
<br>

&copy;
	
	2022 ZackYJ&#39;s Blog
	
</div>
            </div>
    
    <script src="/js/journal.js"></script>
    </body>
</html>
